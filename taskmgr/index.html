<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>바른덴탈 작업관리</title>
    
    <!-- PWA 설정 -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- 스타일 및 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb;
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="text-gray-800">

<div id="root"></div>

<script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { initializeApp } from "firebase/app";
    import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "firebase/auth";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, onSnapshot, serverTimestamp, writeBatch, getDoc, setDoc, orderBy } from "firebase/firestore";
    import { Plus, CheckCircle, Settings, ClipboardList, TrendingUp, DollarSign, Trash2, X, ChevronDown, Lock, Copy, Database, Users, FileText, Calendar, CheckSquare } from 'lucide-react';

    // --- Firebase 설정 ---
    const firebaseConfig = {
       apiKey: "AIzaSyDvZzIleweh5KhxgEC1MJifXHbmxywzQog",
       authDomain: "yupj1-32b66.firebaseapp.com",
       projectId: "yupj1-32b66",
       storageBucket: "yupj1-32b66.firebasestorage.app",
       messagingSenderId: "70353187098",
       appId: "1:70353187098:web:fabf15a6956fa297ef3ca3",
       measurementId: "G-2YT3GJDGK3"
    };

    const appId = 'my-sales-app-v1';
    const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
    const auth = app ? getAuth(app) : null;
    const db = app ? getFirestore(app) : null;

    // --- 유틸리티 ---
    const formatCurrency = (amount) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount).replace('₩', '');
    
    // 날짜 포맷 (MM/DD)
    const formatDate = (date) => {
        if (!date) return '';
        const d = date.seconds ? new Date(date.seconds * 1000) : new Date(date);
        return `${d.getMonth()+1}/${d.getDate()}`;
    };

    // input[type="date"]용 YYYY-MM-DD 문자열 반환 (로컬 시간 기준)
    const toInputDate = (dateObj) => {
        const d = dateObj || new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const STATUS_MAP = {
        'ready': { label: '준비', color: 'text-gray-500 bg-gray-100' },
        'processing': { label: '제판', color: 'text-purple-600 bg-purple-50' },
        'completed': { label: '완료', color: 'text-blue-600 bg-blue-50' },
        'paid': { label: '지급', color: 'text-green-600 bg-green-50' }
    };

    // --- PIN 인증 ---
    const PinAuth = ({ onAuthenticated }) => {
        const [pin, setPin] = useState(['', '', '', '']);
        const [error, setError] = useState('');
        const inputRefs = useRef([]);
        const SHARED_PIN_KEY = `sales_app_pin_${appId}`;

        const handleInput = (index, value) => {
            if (value.length > 1) value = value.slice(-1);
            if (!/^\d*$/.test(value)) return;
            const newPin = [...pin];
            newPin[index] = value;
            setPin(newPin);
            if (value && index < 3) inputRefs.current[index + 1].focus();
            setError('');
            if (index === 3 && value) checkPin([...newPin.slice(0,3), value].join(''));
        };

        const checkPin = (inputPin) => {
            const savedPin = localStorage.getItem(SHARED_PIN_KEY);
            if (!savedPin) {
                if (confirm(`초기 비밀번호를 '${inputPin}'으로 설정하시겠습니까?`)) {
                    localStorage.setItem(SHARED_PIN_KEY, inputPin);
                    onAuthenticated();
                } else {
                    setPin(['','','','']);
                    inputRefs.current[0].focus();
                }
                return;
            }
            if (inputPin === savedPin) onAuthenticated();
            else {
                setError('비밀번호 불일치');
                setTimeout(() => { setPin(['','','','']); inputRefs.current[0].focus(); setError(''); }, 500);
            }
        };

        return (
            <div className="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 animate-fade-in">
                <div className="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center mb-4 text-blue-600"><Lock size={24} /></div>
                <h2 className="text-lg font-bold mb-6 text-gray-800">잠금 해제</h2>
                <div className="flex gap-3 mb-6">
                    {pin.map((digit, idx) => (
                        <input key={idx} ref={el => inputRefs.current[idx] = el} type="password" inputMode="numeric" maxLength={1} className="w-12 h-12 text-center text-xl border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none bg-gray-50 focus:bg-white" value={digit} onChange={(e) => handleInput(idx, e.target.value)} />
                    ))}
                </div>
                {error && <p className="text-red-500 text-xs animate-pulse">{error}</p>}
            </div>
        );
    };

    // --- 콤팩트 자동완성 입력 ---
    const CompactAutocomplete = ({ label, value, onChange, options, placeholder, type = 'text', onSelect }) => {
        const [show, setShow] = useState(false);
        const filtered = useMemo(() => (!value ? [] : options.filter(opt => opt.name.toLowerCase().includes(value.toLowerCase())).slice(0, 3)), [value, options]);

        return (
            <div className="relative">
                <label className="block text-xs font-semibold text-gray-500 mb-1">{label}</label>
                <input type={type} className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none transition-all" placeholder={placeholder} value={value} onChange={(e) => { onChange(e.target.value); setShow(true); }} onFocus={() => setShow(true)} onBlur={() => setTimeout(() => setShow(false), 200)} />
                {show && filtered.length > 0 && (
                    <div className="absolute z-20 w-full bg-white border border-gray-200 rounded shadow-lg mt-1 max-h-32 overflow-y-auto">
                        {filtered.map((opt, idx) => (
                            <div key={idx} className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-xs border-b last:border-0" onClick={() => { onChange(opt.name); if (onSelect) onSelect(opt); setShow(false); }}>
                                <span className="font-medium">{opt.name}</span>
                                {opt.defaultUnitPrice && <span className="text-gray-400 ml-1">({formatCurrency(opt.defaultUnitPrice)})</span>}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    };

    // --- 메인 앱 ---
    const App = () => {
        const [user, setUser] = useState(null);
        const [isAuthenticated, setIsAuthenticated] = useState(() => sessionStorage.getItem('pin_verified') === 'true');
        const [activeTab, setActiveTab] = useState('progress');
        const [loading, setLoading] = useState(true);
        const [tasks, setTasks] = useState([]);
        const [clients, setClients] = useState([]);
        const [products, setProducts] = useState([]);
        
        const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
        const [editingTask, setEditingTask] = useState(null);
        const [isSettlementModalOpen, setIsSettlementModalOpen] = useState(false);
        const [isProductModalOpen, setIsProductModalOpen] = useState(false);

        const [formData, setFormData] = useState({ client: '', productName: '', quantity: 1, unitPrice: 0, expense: 0, description: '' });

        useEffect(() => {
            if (!auth) return;
            signInAnonymously(auth).catch(console.error);
            return onAuthStateChanged(auth, (u) => { setUser(u); if(!u) setLoading(false); });
        }, []);

        useEffect(() => {
            if (!db) return;
            const publicPath = `artifacts/${appId}/public/data`;
            const tasksQ = query(collection(db, `${publicPath}/tasks`), orderBy('createdAt', 'desc'));
            const unsubTasks = onSnapshot(tasksQ, (snap) => { setTasks(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); });
            const unsubClients = onSnapshot(collection(db, `${publicPath}/clients`), (snap) => setClients(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            const unsubProducts = onSnapshot(collection(db, `${publicPath}/products`), (snap) => setProducts(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            return () => { unsubTasks(); unsubClients(); unsubProducts(); };
        }, [db]);

        const handleSaveTask = async (keepOpen = false) => {
            if (!formData.client || !formData.productName) { alert("거래처와 제품명을 입력해주세요."); return; }
            const publicPath = `artifacts/${appId}/public/data`;
            const taskPayload = { ...formData, quantity: Number(formData.quantity), unitPrice: Number(formData.unitPrice), expense: 0, revenue: Number(formData.quantity) * Number(formData.unitPrice), updatedAt: serverTimestamp() };

            try {
                if (editingTask) {
                    await updateDoc(doc(db, `${publicPath}/tasks`, editingTask.id), taskPayload);
                    closeTaskModal();
                } else {
                    await addDoc(collection(db, `${publicPath}/tasks`), { ...taskPayload, status: 'ready', createdAt: serverTimestamp() });
                    if (keepOpen) setFormData(prev => ({ ...prev, productName: '', quantity: 1, unitPrice: 0, description: '' }));
                    else closeTaskModal();
                }
                if (!clients.some(c => c.name === formData.client)) addDoc(collection(db, `${publicPath}/clients`), { name: formData.client });
                const existingProd = products.find(p => p.name === formData.productName);
                if (!existingProd) addDoc(collection(db, `${publicPath}/products`), { name: formData.productName, defaultUnitPrice: Number(formData.unitPrice) });
                else if (existingProd.defaultUnitPrice !== Number(formData.unitPrice)) updateDoc(doc(db, `${publicPath}/products`, existingProd.id), { defaultUnitPrice: Number(formData.unitPrice) });
            } catch (e) { console.error(e); alert("저장 실패: " + e.message); }
        };

        const handleDelete = async () => { if (!editingTask || !confirm("삭제하시겠습니까?")) return; await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, editingTask.id)); closeTaskModal(); };
        const handleStatus = async (id, status) => {
            const update = { status };
            if (status === 'completed') update.completionDate = serverTimestamp();
            if (status === 'paid') update.paymentDate = serverTimestamp();
            await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, id), update);
        };
        const handleBulkPay = async () => {
            const completedItems = tasks.filter(t => t.status === 'completed');
            if (completedItems.length === 0) return;
            if (!confirm(`완료된 ${completedItems.length}건을 모두 '지급' 처리하시겠습니까?`)) return;
            try { const batch = writeBatch(db); completedItems.forEach(t => { const ref = doc(db, `artifacts/${appId}/public/data/tasks`, t.id); batch.update(ref, { status: 'paid', paymentDate: serverTimestamp() }); }); await batch.commit(); alert("일괄 변경되었습니다."); } catch (e) { console.error(e); alert("오류 발생"); }
        };
        
        const openTaskModal = (task = null) => { setEditingTask(task); setFormData(task ? { client: task.client, productName: task.productName, quantity: task.quantity, unitPrice: task.unitPrice, expense: task.expense || 0, description: task.description || '' } : { client: '', productName: '', quantity: 1, unitPrice: 0, expense: 0, description: '' }); setIsTaskModalOpen(true); };
        const closeTaskModal = () => { setIsTaskModalOpen(false); setEditingTask(null); };

        const groupedTasks = useMemo(() => {
            const groups = {};
            const targetTasks = activeTab === 'progress' 
                ? tasks.filter(t => ['ready', 'processing'].includes(t.status))
                : tasks.filter(t => ['completed', 'settlement_requested'].includes(t.status));
            targetTasks.forEach(t => { const client = t.client || '미지정'; if (!groups[client]) groups[client] = []; groups[client].push(t); });
            return groups;
        }, [tasks, activeTab]);

        const settlementTasks = useMemo(() => tasks.filter(t => t.status === 'completed'), [tasks]);

        if (!app) return <div className="p-10 text-center font-bold text-red-500">설정 오류</div>;
        if (!isAuthenticated) return <PinAuth onAuthenticated={() => { setIsAuthenticated(true); sessionStorage.setItem('pin_verified', 'true'); }} />;
        if (loading) return <div className="flex h-screen items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>;

        return (
            <div className="min-h-screen pb-20 max-w-lg mx-auto bg-white shadow-xl min-h-screen border-x border-gray-100 relative">
                <header className="bg-white/95 backdrop-blur-md sticky top-0 z-10 border-b border-gray-100">
                    <div className="px-4 py-2 flex justify-between items-center">
                        <h1 className="text-base font-bold text-gray-800 flex items-center gap-2">바른덴탈 작업관리 <span className="text-[10px] text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">공용</span></h1>
                        <button onClick={() => setIsProductModalOpen(true)} className="p-2 hover:bg-gray-100 rounded-full text-gray-400"><Settings size={16}/></button>
                    </div>
                    <div className="flex px-2">
                        {[ { id: 'progress', label: '진행중', icon: ClipboardList }, { id: 'completed', label: '완료/정산', icon: CheckCircle }, { id: 'stats', label: '통계', icon: TrendingUp } ].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-2 text-xs font-medium flex justify-center items-center gap-1 relative ${activeTab === tab.id ? 'text-blue-600' : 'text-gray-400'}`}>
                                <tab.icon size={14} />{tab.label}{activeTab === tab.id && <div className="absolute bottom-0 w-8 h-0.5 bg-blue-600 rounded-full"></div>}
                            </button>
                        ))}
                    </div>
                </header>

                <main className="p-3 space-y-3">
                    {activeTab === 'completed' && (
                        <div className="flex justify-end gap-2 mb-2">
                            <button onClick={() => { if(settlementTasks.length===0){alert("정산할 '완료' 항목이 없습니다.");return;} setIsSettlementModalOpen(true); }} className="bg-amber-100 text-amber-700 text-xs font-bold py-2 px-3 rounded-lg flex items-center gap-1 shadow-sm active:scale-95"><ClipboardList size={14} /> 정산 명세서</button>
                            <button onClick={handleBulkPay} className="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-3 rounded-lg flex items-center gap-1 shadow-sm active:scale-95"><CheckSquare size={14} /> 전체 지급 처리</button>
                        </div>
                    )}

                    {(activeTab === 'progress' || activeTab === 'completed') && (
                        <div className="animate-fade-in pb-16">
                            {Object.keys(groupedTasks).length === 0 ? <div className="py-20 text-center text-gray-300 text-xs">내역이 없습니다.</div> : 
                                Object.entries(groupedTasks).map(([client, clientTasks]) => (
                                    <div key={client} className="mb-3 bg-white border border-gray-100 rounded-lg shadow-sm overflow-hidden">
                                        <div className="bg-gray-50 px-3 py-1.5 border-b border-gray-100 flex justify-between items-center"><span className="font-bold text-sm text-gray-700">{client}</span><span className="text-[10px] bg-white border px-1.5 rounded text-gray-500">{clientTasks.length}건</span></div>
                                        <div className="divide-y divide-gray-50">
                                            {clientTasks.map(task => (
                                                <div key={task.id} onClick={() => openTaskModal(task)} className="flex items-center p-2 hover:bg-blue-50 active:bg-blue-50 transition cursor-pointer text-xs gap-2">
                                                    <div className="font-bold text-gray-800 w-24 truncate min-w-[90px]">{task.productName}</div>
                                                    <div className="text-blue-600 font-bold whitespace-nowrap min-w-[40px] text-left">{task.quantity}개</div>
                                                    {activeTab === 'completed' && <>
                                                        <div className="text-gray-400 whitespace-nowrap min-w-[50px] text-left">{formatCurrency(task.unitPrice)}</div>
                                                        <div className="font-bold text-gray-800 whitespace-nowrap min-w-[60px] text-left">{formatCurrency(task.revenue)}</div>
                                                    </>}
                                                    <div onClick={e => e.stopPropagation()} className="min-w-[40px]">
                                                        <select value={task.status} onChange={e => handleStatus(task.id, e.target.value)} className={`text-[10px] bg-transparent outline-none font-bold cursor-pointer ${STATUS_MAP[task.status].color.split(' ')[0]}`}>
                                                            {Object.keys(STATUS_MAP).map(k => <option key={k} value={k}>{STATUS_MAP[k].label}</option>)}
                                                        </select>
                                                    </div>
                                                    <div className="text-gray-400 text-[10px] ml-auto whitespace-nowrap">{formatDate(task.updatedAt || task.createdAt)}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    )}

                    {activeTab === 'stats' && <StatsView tasks={tasks.filter(t=>t.status==='paid')} />}
                </main>

                {activeTab === 'progress' && <button onClick={() => openTaskModal()} className="fixed bottom-6 right-6 w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center active:scale-90 z-20"><Plus size={24} strokeWidth={2.5} /></button>}

                {isTaskModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-start justify-center bg-black/40 backdrop-blur-sm animate-fade-in pt-4" onClick={closeTaskModal}>
                        <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl animate-slide-up overflow-hidden mx-4" onClick={e => e.stopPropagation()}>
                            <div className="px-4 py-2.5 border-b flex justify-between items-center bg-gray-50"><h3 className="font-bold text-gray-800 text-sm">{editingTask ? '작업 수정' : '새 작업 등록'}</h3><button onClick={closeTaskModal}><X size={14}/></button></div>
                            <div className="p-4 space-y-3">
                                <div className="grid grid-cols-2 gap-2">
                                    <CompactAutocomplete label="거래처" placeholder="입력" value={formData.client} onChange={v => setFormData({...formData, client: v})} options={clients} />
                                    <CompactAutocomplete label="제품명" placeholder="입력" value={formData.productName} onChange={v => setFormData({...formData, productName: v})} options={products} onSelect={p => setFormData(prev => ({...prev, unitPrice: p.defaultUnitPrice || 0}))} />
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                    <div className="col-span-1"><label className="block text-xs font-semibold text-gray-500 mb-1">수량</label><input type="number" className="w-full px-2 py-2 bg-gray-50 border rounded text-sm text-center font-bold outline-none" value={formData.quantity} onChange={e => setFormData({...formData, quantity: e.target.value})} onFocus={(e) => e.target.select()} /></div>
                                    <div className="col-span-2"><label className="block text-xs font-semibold text-gray-500 mb-1">단가</label><input type="number" className="w-full px-2 py-2 bg-gray-50 border rounded text-sm text-right font-bold outline-none" value={formData.unitPrice} onChange={e => setFormData({...formData, unitPrice: e.target.value})} onFocus={(e) => e.target.select()} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 pt-1">
                                    {editingTask ? <button onClick={handleDelete} className="bg-red-50 text-red-500 py-2.5 rounded font-bold text-xs border border-red-100">삭제</button> : <button onClick={() => handleSaveTask(true)} className="bg-blue-50 text-blue-600 py-2.5 rounded font-bold text-xs border border-blue-100 flex items-center justify-center gap-1"><Plus size={14}/> 저장 후 추가</button>}
                                    <button onClick={() => handleSaveTask(false)} className="bg-blue-600 text-white py-2.5 rounded font-bold text-xs shadow">{editingTask ? '수정 완료' : '등록 완료'}</button>
                                </div>
                                <div><label className="block text-xs font-semibold text-gray-500 mb-1">비고</label><textarea className="w-full px-2 py-2 bg-gray-50 border rounded text-sm h-12 resize-none outline-none" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
                            </div>
                        </div>
                    </div>
                )}
                
                {isProductModalOpen && <ProductManagerModal onClose={()=>setIsProductModalOpen(false)} products={products} db={db} appId={appId} />}
                
                {isSettlementModalOpen && <SettlementPreviewModal tasks={settlementTasks} onClose={() => setIsSettlementModalOpen(false)} onConfirm={async () => { if(!confirm('청구 상태로 변경하시겠습니까?')) return; const batch = writeBatch(db); settlementTasks.forEach(t => batch.update(doc(db, `artifacts/${appId}/public/data/tasks`, t.id), { status: 'settlement_requested', settlementDate: serverTimestamp() })); await batch.commit(); setIsSettlementModalOpen(false); }} />}
            </div>
        );
    };

    const ProductManagerModal = ({ onClose, products, db, appId }) => {
        const [name, setName] = useState(''); const [price, setPrice] = useState('');
        const add = async () => { if(name) { await addDoc(collection(db, `artifacts/${appId}/public/data/products`), {name, defaultUnitPrice:Number(price)}); setName(''); } };
        return <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-6 backdrop-blur-sm"><div className="bg-white w-full max-w-sm rounded-2xl shadow-xl overflow-hidden"><div className="p-3 border-b flex justify-between font-bold items-center"><span>제품 관리</span><button onClick={onClose}><X size={18}/></button></div><div className="p-3 bg-gray-50 border-b flex gap-2"><input className="flex-1 p-2 border rounded-lg text-sm" placeholder="제품명" value={name} onChange={e=>setName(e.target.value)}/><input type="number" className="w-20 p-2 border rounded-lg text-sm" placeholder="단가" value={price} onChange={e=>setPrice(e.target.value)}/><button onClick={add} className="bg-green-500 text-white px-3 rounded-lg text-sm font-bold">추가</button></div><div className="max-h-60 overflow-y-auto p-2">{products.map(p=><div key={p.id} className="flex justify-between p-2 border-b text-sm items-center"><span>{p.name} <span className="text-gray-400 text-xs">({formatCurrency(p.defaultUnitPrice)})</span></span><button onClick={()=>deleteDoc(doc(db,`artifacts/${appId}/public/data/products`,p.id))} className="text-red-400"><Trash2 size={14}/></button></div>)}</div></div></div>;
    };

    const SettlementPreviewModal = ({ tasks, onClose, onConfirm }) => {
        const txt = useMemo(() => { 
            let t = `[정산요청] ${toInputDate(new Date())}\n`; const g = {}; 
            tasks.forEach(i => { const c = i.client||'기타'; if(!g[c]) g[c]=[]; g[c].push(i); }); 
            let tot=0; 
            Object.entries(g).forEach(([c,l]) => { t += `\n■ ${c}\n`; l.forEach(i => { t += `- ${i.productName} (${i.quantity}개): ${formatCurrency(i.revenue)}\n`; tot+=i.revenue; }); }); 
            t += `\n----------------\n총액: ${formatCurrency(tot)}`; return t; 
        }, [tasks]);
        return <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-6" onClick={onClose}><div className="bg-white w-full max-w-sm rounded-2xl shadow-xl flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}><div className="p-3 border-b flex justify-between font-bold"><span>미리보기 ({tasks.length}건)</span><button onClick={onClose}><X size={18}/></button></div><pre className="p-4 bg-gray-50 flex-1 overflow-auto text-xs whitespace-pre-wrap leading-relaxed">{txt}</pre><div className="p-3 border-t flex gap-2"><button onClick={() => navigator.clipboard.writeText(txt).then(()=>alert("복사됨"))} className="flex-1 bg-gray-800 text-white py-2 rounded-lg text-sm font-bold">복사</button><button onClick={onConfirm} className="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-bold">요청 확정</button></div></div></div>;
    };

    const StatsView = ({ tasks }) => {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const [start, setStart] = useState(toInputDate(firstDay));
        const [end, setEnd] = useState(toInputDate(today));

        const filtered = useMemo(() => {
            return tasks.filter(t => {
                // paymentDate가 있으면 사용, 없으면 updatedAt 사용 (데이터 안전망)
                const targetDate = t.paymentDate || t.updatedAt;
                if (!targetDate) return false;
                const d = targetDate.seconds ? new Date(targetDate.seconds * 1000) : new Date(targetDate);
                const dateStr = toInputDate(d);
                return dateStr >= start && dateStr <= end;
            });
        }, [tasks, start, end]);

        const tot = filtered.reduce((a,b)=>a+b.revenue,0);

        return (
            <div className="animate-fade-in pb-16">
                <div className="bg-white border border-gray-100 rounded-xl p-4 mb-3 shadow-sm">
                    <div className="flex gap-2 mb-4">
                        <div className="flex-1"><label className="block text-[10px] text-gray-400 mb-1">시작일</label><input type="date" value={start} onChange={e=>setStart(e.target.value)} className="w-full text-xs border rounded p-1.5 bg-gray-50"/></div>
                        <div className="flex-1"><label className="block text-[10px] text-gray-400 mb-1">종료일</label><input type="date" value={end} onChange={e=>setEnd(e.target.value)} className="w-full text-xs border rounded p-1.5 bg-gray-50"/></div>
                    </div>
                    <div className="flex justify-between items-end border-t border-gray-50 pt-3"><span className="text-xs font-bold text-gray-500">기간 내 지급완료</span><div className="text-xl font-bold text-blue-600">{formatCurrency(tot)}</div></div>
                </div>
                <div className="bg-white border border-gray-100 rounded-xl overflow-hidden shadow-sm">
                    <div className="bg-gray-50 px-4 py-2 text-xs font-bold text-gray-600 border-b border-gray-100 flex justify-between"><span>상세 내역</span><span className="bg-white border px-1.5 rounded text-gray-400">{filtered.length}건</span></div>
                    {filtered.length === 0 ? <div className="p-6 text-center text-gray-300 text-xs">기간 내 내역이 없습니다.</div> :
                        <div className="divide-y divide-gray-50">
                            {filtered.map(t => (
                                <div key={t.id} className="p-3 flex flex-col gap-1 text-xs hover:bg-gray-50">
                                    <div className="flex justify-between text-gray-500 border-b border-gray-50 pb-1 mb-1">
                                        <span className="font-bold text-gray-700">{t.client}</span>
                                        <span className="text-[10px]">{formatDate(t.paymentDate || t.updatedAt)}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="font-bold text-gray-800">{t.productName}</span>
                                        <div className="flex gap-1 text-gray-500">
                                            <span className="text-blue-600 font-bold">{t.quantity}개</span>
                                            <span>x {formatCurrency(t.unitPrice)}</span>
                                            <span className="font-bold text-gray-800">= {formatCurrency(t.revenue)}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    }
                </div>
            </div>
        );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>

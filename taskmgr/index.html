<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>모바일 작업관리 (팀 공유용)</title>
    
    <!-- 1. 스타일 및 폰트 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- 2. 리액트 실행을 위한 도구 (Babel) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 외부 라이브러리 연결 -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        @keyframes slideUp { 
            from { transform: translateY(100%); } 
            to { transform: translateY(0); } 
        }
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }

        /* 스크롤바 숨기기 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* 모달 입력창 포커스 시 줌 방지 (iOS) */
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="text-gray-800">

<div id="root"></div>

<!-- 메인 로직 시작 -->
<script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { initializeApp } from "firebase/app";
    import { 
        getAuth, 
        signInAnonymously, 
        onAuthStateChanged,
        setPersistence,
        browserLocalPersistence 
    } from "firebase/auth";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        updateDoc, 
        deleteDoc, 
        doc, 
        query, 
        onSnapshot, 
        serverTimestamp, 
        writeBatch,
        getDoc,
        setDoc,
        orderBy 
    } from "firebase/firestore";
    import { 
        Plus, CheckCircle, Settings, ClipboardList, TrendingUp, 
        DollarSign, Trash2, X, ChevronDown, Lock, Copy, Database, Users
    } from 'lucide-react';

    // =================================================================
    // [설정 영역] 본인의 파이어베이스 키를 여기에 넣어주세요.
    // =================================================================
    const firebaseConfig = {
       apiKey: "AIzaSyDvZzIleweh5KhxgEC1MJifXHbmxywzQog",
       authDomain: "yupj1-32b66.firebaseapp.com",
       projectId: "yupj1-32b66",
       storageBucket: "yupj1-32b66.firebasestorage.app",
       messagingSenderId: "70353187098",
       appId: "1:70353187098:web:fabf15a6956fa297ef3ca3",
       measurementId: "G-2YT3GJDGK3"
    };

    const appId = 'my-sales-app-v1';

    const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
    const auth = app ? getAuth(app) : null;
    const db = app ? getFirestore(app) : null;

    // --- 유틸리티 ---
    const formatCurrency = (amount) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount).replace('₩', '') + '원';
    const formatDate = (date) => {
        if (!date) return '';
        const d = date.seconds ? new Date(date.seconds * 1000) : new Date(date);
        return `${d.getMonth()+1}/${d.getDate()}`;
    };

    const STATUS_MAP = {
        'ready': { label: '준비', color: 'bg-gray-100 text-gray-600 border-gray-300', dot: 'bg-gray-400' },
        'processing': { label: '가공', color: 'bg-purple-100 text-purple-700 border-purple-200', dot: 'bg-purple-500' },
        'completed': { label: '완료', color: 'bg-blue-100 text-blue-700 border-blue-200', dot: 'bg-blue-500' },
        'settlement_requested': { label: '청구됨', color: 'bg-amber-100 text-amber-700 border-amber-200', dot: 'bg-amber-500' },
        'paid': { label: '지급됨', color: 'bg-green-100 text-green-700 border-green-200', dot: 'bg-green-500' }
    };

    // --- PIN 인증 컴포넌트 (공용 설정 사용으로 변경) ---
    const PinAuth = ({ onAuthenticated }) => {
        const [pin, setPin] = useState(['', '', '', '']);
        const [error, setError] = useState('');
        const inputRefs = useRef([]);

        // 간단한 로컬 PIN 인증 (팀 공용 비밀번호 개념)
        // 실제 운영 시에는 파이어베이스에 저장된 공용 PIN을 불러와서 비교하는 것이 좋으나
        // 여기서는 초기 편의성을 위해 '0000' 또는 로컬 스토리지 설정을 사용
        const SHARED_PIN_KEY = `sales_app_pin_${appId}`;

        const handleInput = (index, value) => {
            if (value.length > 1) value = value.slice(-1);
            if (!/^\d*$/.test(value)) return;
            const newPin = [...pin];
            newPin[index] = value;
            setPin(newPin);
            if (value && index < 3) inputRefs.current[index + 1].focus();
            setError('');
            
            // 자동 제출
            if (index === 3 && value) {
                checkPin([...newPin.slice(0,3), value].join(''));
            }
        };

        const checkPin = (inputPin) => {
            const savedPin = localStorage.getItem(SHARED_PIN_KEY);
            
            // PIN이 아직 설정 안됐으면 최초 설정
            if (!savedPin) {
                if (confirm(`초기 비밀번호를 '${inputPin}'으로 설정하시겠습니까?`)) {
                    localStorage.setItem(SHARED_PIN_KEY, inputPin);
                    onAuthenticated();
                } else {
                    setPin(['','','','']);
                    inputRefs.current[0].focus();
                }
                return;
            }

            if (inputPin === savedPin) {
                onAuthenticated();
            } else {
                setError('비밀번호가 일치하지 않습니다.');
                setTimeout(() => {
                    setPin(['','','','']);
                    inputRefs.current[0].focus();
                    setError('');
                }, 500);
            }
        };

        return (
            <div className="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 animate-fade-in">
                <div className="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mb-6 text-blue-600 shadow-sm">
                    <Lock size={28} />
                </div>
                <h2 className="text-xl font-bold mb-2 text-gray-800">잠금 해제</h2>
                <p className="text-gray-500 mb-8 text-sm">팀 접속 비밀번호 4자리를 입력하세요</p>
                <div className="flex gap-3 mb-8">
                    {pin.map((digit, idx) => (
                        <input key={idx} ref={el => inputRefs.current[idx] = el} type="password" inputMode="numeric" maxLength={1} className="w-12 h-14 text-center text-2xl border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all bg-gray-50 focus:bg-white shadow-sm" value={digit} onChange={(e) => handleInput(idx, e.target.value)} />
                    ))}
                </div>
                {error && <p className="text-red-500 text-sm font-medium animate-pulse">{error}</p>}
                {!localStorage.getItem(`sales_app_pin_${appId}`) && <p className="text-xs text-blue-500 mt-4">* 처음 입력하는 번호가 비밀번호로 설정됩니다.</p>}
            </div>
        );
    };

    // --- 콤팩트한 자동완성 입력 (모달용) ---
    const CompactAutocomplete = ({ label, value, onChange, options, placeholder, type = 'text', onSelect }) => {
        const [show, setShow] = useState(false);
        const filtered = useMemo(() => (!value ? [] : options.filter(opt => opt.name.toLowerCase().includes(value.toLowerCase())).slice(0, 3)), [value, options]);

        return (
            <div className="relative">
                <label className="block text-xs font-semibold text-gray-500 mb-1">{label}</label>
                <input 
                    type={type} 
                    className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm transition-all" 
                    placeholder={placeholder} 
                    value={value} 
                    onChange={(e) => { onChange(e.target.value); setShow(true); }} 
                    onFocus={() => setShow(true)} 
                    onBlur={() => setTimeout(() => setShow(false), 200)} 
                />
                {show && filtered.length > 0 && (
                    <div className="absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-32 overflow-y-auto">
                        {filtered.map((opt, idx) => (
                            <div key={idx} className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b last:border-0" onClick={() => { onChange(opt.name); if (onSelect) onSelect(opt); setShow(false); }}>
                                <span className="font-medium">{opt.name}</span>
                                {opt.defaultUnitPrice && <span className="text-xs text-gray-400 ml-1">({formatCurrency(opt.defaultUnitPrice)})</span>}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    };

    // --- 메인 앱 ---
    const App = () => {
        const [user, setUser] = useState(null);
        const [isAuthenticated, setIsAuthenticated] = useState(() => sessionStorage.getItem('pin_verified') === 'true');
        const [activeTab, setActiveTab] = useState('progress');
        const [loading, setLoading] = useState(true);
        
        // 데이터 상태
        const [tasks, setTasks] = useState([]);
        const [clients, setClients] = useState([]);
        const [products, setProducts] = useState([]);
        
        // 모달 상태
        const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
        const [editingTask, setEditingTask] = useState(null);
        const [isSettlementModalOpen, setIsSettlementModalOpen] = useState(false);
        const [isProductModalOpen, setIsProductModalOpen] = useState(false);

        // 폼 데이터
        const [formData, setFormData] = useState({ client: '', productName: '', quantity: 1, unitPrice: 10000, expense: 0, description: '' });

        // 1. 인증 및 초기화
        useEffect(() => {
            if (!auth) return;
            signInAnonymously(auth).catch(console.error);
            return onAuthStateChanged(auth, (u) => { setUser(u); if(!u) setLoading(false); });
        }, []);

        // 2. 데이터 동기화 (경로 변경: users/{uid} -> public/data)
        // ** 핵심 수정사항: 공용 경로(public/data)를 사용하여 모든 브라우저에서 데이터 공유 **
        useEffect(() => {
            if (!db) return;
            
            // 공용 경로 설정 (appId 기준)
            const publicPath = `artifacts/${appId}/public/data`;

            const tasksQ = query(collection(db, `${publicPath}/tasks`), orderBy('createdAt', 'desc')); // 최신순 정렬 추가
            const clientsQ = collection(db, `${publicPath}/clients`);
            const productsQ = collection(db, `${publicPath}/products`);

            const unsubTasks = onSnapshot(tasksQ, (snap) => {
                setTasks(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                setLoading(false);
            }, (err) => console.error("Tasks Sync Error:", err)); // 에러 로깅 추가

            const unsubClients = onSnapshot(clientsQ, (snap) => setClients(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            const unsubProducts = onSnapshot(productsQ, (snap) => setProducts(snap.docs.map(d => ({id: d.id, ...d.data()}))));

            return () => { unsubTasks(); unsubClients(); unsubProducts(); };
        }, [db]); // user 의존성 제거 (공용 데이터이므로 user id 불필요)

        // 3. 액션 핸들러
        const handleSaveTask = async () => {
            if (!formData.client || !formData.productName) { alert("거래처와 제품명을 입력해주세요."); return; }
            const publicPath = `artifacts/${appId}/public/data`;
            
            const taskPayload = {
                ...formData,
                quantity: Number(formData.quantity),
                unitPrice: Number(formData.unitPrice),
                expense: Number(formData.expense),
                revenue: Number(formData.quantity) * Number(formData.unitPrice),
                updatedAt: serverTimestamp()
            };

            try {
                if (editingTask) {
                    await updateDoc(doc(db, `${publicPath}/tasks`, editingTask.id), taskPayload);
                } else {
                    await addDoc(collection(db, `${publicPath}/tasks`), {
                        ...taskPayload,
                        status: 'ready',
                        createdAt: serverTimestamp()
                    });
                }

                // 마스터 데이터 자동 등록
                if (!clients.some(c => c.name === formData.client)) addDoc(collection(db, `${publicPath}/clients`), { name: formData.client });
                
                const existingProd = products.find(p => p.name === formData.productName);
                if (!existingProd) {
                    addDoc(collection(db, `${publicPath}/products`), { name: formData.productName, defaultUnitPrice: Number(formData.unitPrice) });
                } else if (existingProd.defaultUnitPrice !== Number(formData.unitPrice)) {
                    updateDoc(doc(db, `${publicPath}/products`, existingProd.id), { defaultUnitPrice: Number(formData.unitPrice) });
                }

                closeTaskModal();
            } catch (e) {
                console.error(e);
                if (e.code === 'permission-denied') alert("데이터베이스 권한 오류입니다. Firestore 규칙을 확인해주세요.");
                else alert("저장 실패: " + e.message);
            }
        };

        const handleDelete = async () => {
            if (!editingTask || !confirm("삭제하시겠습니까?")) return;
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, editingTask.id));
            closeTaskModal();
        };

        const handleStatus = async (id, status) => {
            const update = { status };
            if (status === 'completed') update.completionDate = serverTimestamp();
            if (status === 'paid') update.paymentDate = serverTimestamp();
            await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, id), update);
        };
        
        // 모달 제어
        const openTaskModal = (task = null) => {
            setEditingTask(task);
            setFormData(task ? { 
                client: task.client, productName: task.productName, 
                quantity: task.quantity, unitPrice: task.unitPrice, 
                expense: task.expense || 0, description: task.description || '' 
            } : { 
                client: '', productName: '', quantity: 1, unitPrice: 10000, expense: 0, description: '' 
            });
            setIsTaskModalOpen(true);
        };
        const closeTaskModal = () => { setIsTaskModalOpen(false); setEditingTask(null); };

        // 렌더링 준비
        if (!app) return <div className="p-10 text-center font-bold text-red-500">설정 오류: firebaseConfig가 비어있습니다.</div>;
        if (!isAuthenticated) return <PinAuth onAuthenticated={() => { setIsAuthenticated(true); sessionStorage.setItem('pin_verified', 'true'); }} />;
        if (loading) return <div className="flex h-screen items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>;

        const progressTasks = tasks.filter(t => ['ready', 'processing'].includes(t.status));
        const completedTasks = tasks.filter(t => ['completed', 'settlement_requested'].includes(t.status));
        
        return (
            <div className="min-h-screen pb-20 md:pb-0 max-w-lg mx-auto bg-white shadow-xl min-h-screen border-x border-gray-100">
                {/* 헤더 */}
                <header className="bg-white/90 backdrop-blur-md sticky top-0 z-10 border-b border-gray-100">
                    <div className="px-4 py-3 flex justify-between items-center">
                        <h1 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span className="w-2 h-6 bg-blue-600 rounded-full"></span>
                            작업관리 <span className="text-xs text-gray-400 font-normal bg-gray-100 px-2 py-0.5 rounded-full">공용</span>
                        </h1>
                        <button onClick={() => setIsProductModalOpen(true)} className="p-2 hover:bg-gray-100 rounded-full text-gray-500"><Settings size={18}/></button>
                    </div>
                    <div className="flex px-2">
                        {[ { id: 'progress', label: '진행중', icon: ClipboardList }, { id: 'completed', label: '완료/정산', icon: CheckCircle }, { id: 'stats', label: '통계', icon: TrendingUp } ].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-3 text-sm font-medium flex justify-center items-center gap-1.5 relative ${activeTab === tab.id ? 'text-blue-600' : 'text-gray-400'}`}>
                                <tab.icon size={16} strokeWidth={2.5} />{tab.label}
                                {activeTab === tab.id && <div className="absolute bottom-0 w-8 h-0.5 bg-blue-600 rounded-full"></div>}
                            </button>
                        ))}
                    </div>
                </header>

                <main className="p-3 space-y-3">
                    {activeTab === 'progress' && (
                        <div className="animate-fade-in pb-10">
                            <button onClick={() => openTaskModal()} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 flex items-center justify-center gap-2 transition-transform active:scale-95 mb-4">
                                <Plus size={18} strokeWidth={3} /> 작업 등록하기
                            </button>
                            {progressTasks.length === 0 ? <div className="py-20 text-center text-gray-300 text-sm flex flex-col items-center"><div className="w-12 h-12 bg-gray-50 rounded-full flex items-center justify-center mb-2"><ClipboardList size={24} className="opacity-20"/></div>할 일이 없습니다.</div> : 
                                progressTasks.map(task => <TaskItem key={task.id} task={task} onClick={() => openTaskModal(task)} onStatusChange={handleStatus} />)
                            }
                        </div>
                    )}
                    {activeTab === 'completed' && (
                        <div className="animate-fade-in pb-10">
                            <div className="bg-amber-50 border border-amber-100 p-3 rounded-xl flex justify-between items-center mb-3">
                                <div><div className="text-xs text-amber-700 font-bold mb-0.5">정산 대기금액</div><div className="text-xl font-bold text-amber-900">{formatCurrency(completedTasks.filter(t=>t.status==='completed').reduce((a,b)=>a+b.revenue,0))}</div></div>
                                <button onClick={() => setIsSettlementModalOpen(true)} className="bg-amber-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-sm">명세서</button>
                            </div>
                            {completedTasks.map(task => <TaskItem key={task.id} task={task} onClick={() => openTaskModal(task)} onStatusChange={handleStatus} readonly={task.status === 'settlement_requested'} />)}
                        </div>
                    )}
                    {activeTab === 'stats' && <StatsView tasks={tasks.filter(t=>t.status==='paid')} />}
                </main>

                {/* --- 콤팩트 모달 (모바일 최적화) --- */}
                {isTaskModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm animate-fade-in">
                        <div className="bg-white w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl animate-slide-up overflow-hidden">
                            {/* 모달 헤더 (축소) */}
                            <div className="px-4 py-3 border-b flex justify-between items-center bg-gray-50/50">
                                <h3 className="font-bold text-gray-800">{editingTask ? '작업 수정' : '새 작업'}</h3>
                                <button onClick={closeTaskModal} className="w-7 h-7 flex items-center justify-center bg-gray-200 rounded-full text-gray-500"><X size={16}/></button>
                            </div>
                            
                            {/* 모달 내용 (패딩 축소, 그리드 적용) */}
                            <div className="p-4 space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <CompactAutocomplete label="거래처" placeholder="입력/선택" value={formData.client} onChange={v => setFormData({...formData, client: v})} options={clients} />
                                    <CompactAutocomplete label="제품명" placeholder="입력/선택" value={formData.productName} onChange={v => setFormData({...formData, productName: v})} options={products} onSelect={p => setFormData(prev => ({...prev, unitPrice: p.defaultUnitPrice || 0}))} />
                                </div>

                                <div className="grid grid-cols-3 gap-3">
                                    <div className="col-span-1">
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">수량</label>
                                        <input type="number" className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-center font-bold focus:ring-1 focus:ring-blue-500 outline-none" value={formData.quantity} onChange={e => setFormData({...formData, quantity: e.target.value})} />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">단가</label>
                                        <input type="number" className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-right font-bold focus:ring-1 focus:ring-blue-500 outline-none" value={formData.unitPrice} onChange={e => setFormData({...formData, unitPrice: e.target.value})} />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">지출(비용)</label>
                                        <input type="number" className="w-full px-3 py-2 bg-red-50 border border-red-100 rounded-lg text-sm text-red-600 font-bold focus:ring-1 focus:ring-red-500 outline-none" value={formData.expense} onChange={e => setFormData({...formData, expense: e.target.value})} />
                                    </div>
                                    <div className="flex flex-col justify-end pb-1 text-right">
                                        <div className="text-xs text-gray-400">예상 매출</div>
                                        <div className="text-lg font-bold text-blue-600">{formatCurrency(formData.quantity * formData.unitPrice)}</div>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1">비고</label>
                                    <textarea className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm h-14 resize-none focus:ring-1 focus:ring-blue-500 outline-none" placeholder="메모 입력" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
                                </div>

                                {/* 하단 버튼 (높이 축소) */}
                                <div className="flex gap-2 pt-2">
                                    {editingTask && (
                                        <button onClick={handleDelete} className="bg-red-50 text-red-500 w-12 rounded-lg flex items-center justify-center border border-red-100"><Trash2 size={18}/></button>
                                    )}
                                    <button onClick={handleSaveTask} className="flex-1 bg-blue-600 text-white h-11 rounded-lg font-bold shadow-md hover:bg-blue-700 active:scale-95 transition-all">
                                        {editingTask ? '수정 완료' : '등록하기'}
                                    </button>
                                </div>
                            </div>
                            {/* 모바일 키보드 공간 확보용 하단 여백 */}
                            <div className="h-4 bg-white"></div>
                        </div>
                    </div>
                )}
                
                {/* 기타 모달들 (간소화) */}
                {isSettlementModalOpen && <SettlementPreviewModal tasks={completedTasks.filter(t=>t.status==='completed')} onClose={()=>setIsSettlementModalOpen(false)} onConfirm={async ()=>{ const batch=writeBatch(db); completedTasks.filter(t=>t.status==='completed').forEach(t=>batch.update(doc(db,`artifacts/${appId}/public/data/tasks`,t.id),{status:'settlement_requested', settlementDate:serverTimestamp()})); await batch.commit(); setIsSettlementModalOpen(false); }} />}
                {isProductModalOpen && <ProductManagerModal onClose={()=>setIsProductModalOpen(false)} products={products} db={db} appId={appId} />}
            </div>
        );
    };

    // --- 서브 컴포넌트: 아이템 (디자인 개선) ---
    const TaskItem = ({ task, onClick, onStatusChange, readonly }) => {
        const conf = STATUS_MAP[task.status] || STATUS_MAP['ready'];
        return (
            <div onClick={onClick} className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm active:bg-gray-50 transition-colors flex gap-3 relative overflow-hidden">
                <div className={`w-1.5 absolute left-0 top-0 bottom-0 ${conf.color.split(' ')[0]}`}></div>
                <div className="flex-1 pl-2">
                    <div className="flex justify-between items-start mb-0.5">
                        <div className="font-bold text-gray-800 text-sm leading-tight">{task.productName}</div>
                        <span className="text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded">{formatDate(task.updatedAt || task.createdAt)}</span>
                    </div>
                    <div className="text-xs text-gray-500 mb-1.5">{task.client} · {task.quantity}개</div>
                    <div className="flex justify-between items-end">
                        <div className="font-bold text-gray-900 text-sm">{formatCurrency(task.revenue)}</div>
                        <div onClick={e => e.stopPropagation()} className="relative z-10">
                            <select value={task.status} disabled={readonly} onChange={e => onStatusChange(task.id, e.target.value)} 
                                className={`text-[11px] font-bold px-2 py-1 rounded-md border appearance-none outline-none pr-5 ${conf.color} ${readonly ? 'opacity-50' : ''}`}>
                                {Object.keys(STATUS_MAP).map(k => <option key={k} value={k}>{STATUS_MAP[k].label}</option>)}
                            </select>
                            <ChevronDown size={10} className="absolute right-1.5 top-1.5 opacity-50 pointer-events-none"/>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    // --- 서브: 제품관리 모달 ---
    const ProductManagerModal = ({ onClose, products, db, appId }) => {
        const [name, setName] = useState(''); const [price, setPrice] = useState('');
        const add = async () => { if(name) { await addDoc(collection(db, `artifacts/${appId}/public/data/products`), {name, defaultUnitPrice:Number(price)}); setName(''); } };
        return <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-6 backdrop-blur-sm"><div className="bg-white w-full max-w-sm rounded-2xl shadow-xl overflow-hidden"><div className="p-3 border-b flex justify-between font-bold items-center bg-gray-50"><span>제품 관리</span><button onClick={onClose}><X size={18}/></button></div><div className="p-3 bg-gray-50 border-b flex gap-2"><input className="flex-1 p-2 border rounded-lg text-sm" placeholder="제품명" value={name} onChange={e=>setName(e.target.value)}/><input type="number" className="w-20 p-2 border rounded-lg text-sm" placeholder="단가" value={price} onChange={e=>setPrice(e.target.value)}/><button onClick={add} className="bg-green-500 text-white px-3 rounded-lg text-sm font-bold">추가</button></div><div className="max-h-60 overflow-y-auto p-2">{products.map(p=><div key={p.id} className="flex justify-between p-2 border-b last:border-0 text-sm items-center"><span>{p.name} <span className="text-gray-400 text-xs">({formatCurrency(p.defaultUnitPrice)})</span></span><button onClick={()=>deleteDoc(doc(db,`artifacts/${appId}/public/data/products`,p.id))} className="text-red-400"><Trash2 size={14}/></button></div>)}</div></div></div>;
    };

    // --- 서브: 정산 미리보기 ---
    const SettlementPreviewModal = ({ tasks, onClose, onConfirm }) => {
        const txt = useMemo(() => { let t = `[정산요청] ${new Date().toLocaleDateString()}\n`; const g = {}; tasks.forEach(i => { const c = i.client||'기타'; if(!g[c]) g[c]=[]; g[c].push(i); }); let tot=0; Object.entries(g).forEach(([c,l]) => { t += `\n■ ${c}\n`; l.forEach(i => { t += `- ${i.productName} (${i.quantity}개): ${formatCurrency(i.revenue)}\n`; tot+=i.revenue; }); }); t += `\n총액: ${formatCurrency(tot)}`; return t; }, [tasks]);
        const copy = () => { navigator.clipboard.writeText(txt).then(()=>alert("복사됨")); };
        return <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-6"><div className="bg-white w-full max-w-sm rounded-2xl shadow-xl flex flex-col max-h-[80vh]"><div className="p-3 border-b flex justify-between font-bold"><span>미리보기</span><button onClick={onClose}><X size={18}/></button></div><pre className="p-4 bg-gray-50 flex-1 overflow-auto text-xs whitespace-pre-wrap leading-relaxed">{txt}</pre><div className="p-3 border-t flex gap-2"><button onClick={copy} className="flex-1 bg-gray-800 text-white py-2 rounded-lg text-sm font-bold">복사</button><button onClick={onConfirm} className="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-bold">요청 확정</button></div></div></div>;
    };

    // --- 서브: 통계 ---
    const StatsView = ({ tasks }) => {
        const [m, setM] = useState(new Date().toISOString().slice(0,7));
        const f = tasks.filter(t => t.paymentDate && formatDate(t.paymentDate).startsWith(parseInt(m.slice(5)))); // 단순 월 필터링
        const tot = f.reduce((a,b)=>a+b.revenue,0);
        return <div className="animate-fade-in"><div className="bg-white border rounded-xl p-4 mb-4"><div className="flex justify-between items-center mb-2"><span className="text-sm font-bold text-gray-500">이번 달 순수익</span><input type="month" value={m} onChange={e=>setM(e.target.value)} className="text-xs border rounded p-1"/></div><div className="text-2xl font-bold text-blue-600">{formatCurrency(tot)}</div></div><div className="bg-white border rounded-xl overflow-hidden"><div className="bg-gray-50 px-4 py-2 text-xs font-bold text-gray-500">지급 완료 목록</div>{f.map(t=><div key={t.id} className="p-3 border-b last:border-0 flex justify-between text-sm"><span>{t.productName}</span><span className="font-bold text-green-600">+{formatCurrency(t.revenue)}</span></div>)}</div></div>;
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>모바일 작업관리 (팀 공유용)</title>
    
    <!-- 1. 스타일 및 폰트 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- 2. 리액트 실행을 위한 도구 (Babel) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 외부 라이브러리 연결 -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        @keyframes slideUp { 
            from { transform: translateY(-20px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }

        /* 스크롤바 숨기기 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* 모달 입력창 포커스 시 줌 방지 (iOS) */
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="text-gray-800">

<div id="root"></div>

<!-- 메인 로직 시작 -->
<script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { initializeApp } from "firebase/app";
    import { 
        getAuth, 
        signInAnonymously, 
        onAuthStateChanged,
        setPersistence,
        browserLocalPersistence 
    } from "firebase/auth";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        updateDoc, 
        deleteDoc, 
        doc, 
        query, 
        onSnapshot, 
        serverTimestamp, 
        writeBatch,
        getDoc,
        setDoc,
        orderBy 
    } from "firebase/firestore";
    import { 
        Plus, CheckCircle, Settings, ClipboardList, TrendingUp, 
        DollarSign, Trash2, X, ChevronDown, Lock, Copy, Database, Users, FileText, Calendar
    } from 'lucide-react';

    // =================================================================
    // [설정 영역] 본인의 파이어베이스 키를 여기에 넣어주세요.
    // =================================================================
    const firebaseConfig = {
       apiKey: "AIzaSyDvZzIleweh5KhxgEC1MJifXHbmxywzQog",
       authDomain: "yupj1-32b66.firebaseapp.com",
       projectId: "yupj1-32b66",
       storageBucket: "yupj1-32b66.firebasestorage.app",
       messagingSenderId: "70353187098",
       appId: "1:70353187098:web:fabf15a6956fa297ef3ca3",
       measurementId: "G-2YT3GJDGK3"
    };

    const appId = 'my-sales-app-v1';

    const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
    const auth = app ? getAuth(app) : null;
    const db = app ? getFirestore(app) : null;

    // --- 유틸리티 ---
    const formatCurrency = (amount) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount).replace('₩', '') + '원';
    const formatDate = (date) => {
        if (!date) return '';
        const d = date.seconds ? new Date(date.seconds * 1000) : new Date(date);
        return `${d.getMonth()+1}/${d.getDate()}`;
    };

    const STATUS_MAP = {
        'ready': { label: '준비', color: 'text-gray-500 bg-gray-100', dot: 'bg-gray-400' },
        'processing': { label: '가공', color: 'text-purple-600 bg-purple-50', dot: 'bg-purple-500' },
        'completed': { label: '완료', color: 'text-blue-600 bg-blue-50', dot: 'bg-blue-500' },
        'settlement_requested': { label: '청구', color: 'text-amber-600 bg-amber-50', dot: 'bg-amber-500' },
        'paid': { label: '지급', color: 'text-green-600 bg-green-50', dot: 'bg-green-500' }
    };

    // --- PIN 인증 컴포넌트 ---
    const PinAuth = ({ onAuthenticated }) => {
        const [pin, setPin] = useState(['', '', '', '']);
        const [error, setError] = useState('');
        const inputRefs = useRef([]);
        const SHARED_PIN_KEY = `sales_app_pin_${appId}`;

        const handleInput = (index, value) => {
            if (value.length > 1) value = value.slice(-1);
            if (!/^\d*$/.test(value)) return;
            const newPin = [...pin];
            newPin[index] = value;
            setPin(newPin);
            if (value && index < 3) inputRefs.current[index + 1].focus();
            setError('');
            if (index === 3 && value) checkPin([...newPin.slice(0,3), value].join(''));
        };

        const checkPin = (inputPin) => {
            const savedPin = localStorage.getItem(SHARED_PIN_KEY);
            if (!savedPin) {
                if (confirm(`초기 비밀번호를 '${inputPin}'으로 설정하시겠습니까?`)) {
                    localStorage.setItem(SHARED_PIN_KEY, inputPin);
                    onAuthenticated();
                } else {
                    setPin(['','','','']);
                    inputRefs.current[0].focus();
                }
                return;
            }
            if (inputPin === savedPin) onAuthenticated();
            else {
                setError('비밀번호 불일치');
                setTimeout(() => { setPin(['','','','']); inputRefs.current[0].focus(); setError(''); }, 500);
            }
        };

        return (
            <div className="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 animate-fade-in">
                <div className="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center mb-4 text-blue-600">
                    <Lock size={24} />
                </div>
                <h2 className="text-lg font-bold mb-6 text-gray-800">잠금 해제</h2>
                <div className="flex gap-3 mb-6">
                    {pin.map((digit, idx) => (
                        <input key={idx} ref={el => inputRefs.current[idx] = el} type="password" inputMode="numeric" maxLength={1} className="w-12 h-12 text-center text-xl border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none bg-gray-50 focus:bg-white" value={digit} onChange={(e) => handleInput(idx, e.target.value)} />
                    ))}
                </div>
                {error && <p className="text-red-500 text-xs animate-pulse">{error}</p>}
            </div>
        );
    };

    // --- 콤팩트한 자동완성 입력 ---
    const CompactAutocomplete = ({ label, value, onChange, options, placeholder, type = 'text', onSelect }) => {
        const [show, setShow] = useState(false);
        const filtered = useMemo(() => (!value ? [] : options.filter(opt => opt.name.toLowerCase().includes(value.toLowerCase())).slice(0, 3)), [value, options]);

        return (
            <div className="relative">
                <label className="block text-xs font-semibold text-gray-500 mb-1">{label}</label>
                <input 
                    type={type} 
                    className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none transition-all" 
                    placeholder={placeholder} 
                    value={value} 
                    onChange={(e) => { onChange(e.target.value); setShow(true); }} 
                    onFocus={() => setShow(true)} 
                    onBlur={() => setTimeout(() => setShow(false), 200)} 
                />
                {show && filtered.length > 0 && (
                    <div className="absolute z-20 w-full bg-white border border-gray-200 rounded shadow-lg mt-1 max-h-32 overflow-y-auto">
                        {filtered.map((opt, idx) => (
                            <div key={idx} className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-xs border-b last:border-0" onClick={() => { onChange(opt.name); if (onSelect) onSelect(opt); setShow(false); }}>
                                <span className="font-medium">{opt.name}</span>
                                {opt.defaultUnitPrice && <span className="text-gray-400 ml-1">({formatCurrency(opt.defaultUnitPrice)})</span>}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    };

    // --- 메인 앱 ---
    const App = () => {
        const [user, setUser] = useState(null);
        const [isAuthenticated, setIsAuthenticated] = useState(() => sessionStorage.getItem('pin_verified') === 'true');
        const [activeTab, setActiveTab] = useState('progress');
        const [loading, setLoading] = useState(true);
        
        const [tasks, setTasks] = useState([]);
        const [clients, setClients] = useState([]);
        const [products, setProducts] = useState([]);
        
        const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
        const [editingTask, setEditingTask] = useState(null);
        const [isSettlementModalOpen, setIsSettlementModalOpen] = useState(false);
        const [isProductModalOpen, setIsProductModalOpen] = useState(false);

        const [formData, setFormData] = useState({ client: '', productName: '', quantity: 1, unitPrice: 0, expense: 0, description: '' });

        useEffect(() => {
            if (!auth) return;
            signInAnonymously(auth).catch(console.error);
            return onAuthStateChanged(auth, (u) => { setUser(u); if(!u) setLoading(false); });
        }, []);

        useEffect(() => {
            if (!db) return;
            const publicPath = `artifacts/${appId}/public/data`;
            const tasksQ = query(collection(db, `${publicPath}/tasks`), orderBy('createdAt', 'desc'));
            const unsubTasks = onSnapshot(tasksQ, (snap) => { setTasks(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); });
            const unsubClients = onSnapshot(collection(db, `${publicPath}/clients`), (snap) => setClients(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            const unsubProducts = onSnapshot(collection(db, `${publicPath}/products`), (snap) => setProducts(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            return () => { unsubTasks(); unsubClients(); unsubProducts(); };
        }, [db]);

        // 저장 함수 (keepOpen: 저장 후 입력창 유지 여부)
        const handleSaveTask = async (keepOpen = false) => {
            if (!formData.client || !formData.productName) { alert("거래처와 제품명을 입력해주세요."); return; }
            const publicPath = `artifacts/${appId}/public/data`;
            
            const taskPayload = {
                ...formData,
                quantity: Number(formData.quantity),
                unitPrice: Number(formData.unitPrice),
                expense: 0,
                revenue: Number(formData.quantity) * Number(formData.unitPrice),
                updatedAt: serverTimestamp()
            };

            try {
                if (editingTask) {
                    await updateDoc(doc(db, `${publicPath}/tasks`, editingTask.id), taskPayload);
                    closeTaskModal();
                } else {
                    await addDoc(collection(db, `${publicPath}/tasks`), {
                        ...taskPayload,
                        status: 'ready',
                        createdAt: serverTimestamp()
                    });
                    
                    if (keepOpen) {
                        // 연속 입력을 위해 거래처는 유지하고 나머지 초기화
                        setFormData(prev => ({ ...prev, productName: '', quantity: 1, unitPrice: 0, description: '' }));
                        // 간단한 피드백 (Toast 대신 Alert나 콘솔)
                        console.log("저장되었습니다. 다음 항목을 입력하세요.");
                    } else {
                        closeTaskModal();
                    }
                }

                if (!clients.some(c => c.name === formData.client)) addDoc(collection(db, `${publicPath}/clients`), { name: formData.client });
                
                const existingProd = products.find(p => p.name === formData.productName);
                if (!existingProd) {
                    addDoc(collection(db, `${publicPath}/products`), { name: formData.productName, defaultUnitPrice: Number(formData.unitPrice) });
                } else if (existingProd.defaultUnitPrice !== Number(formData.unitPrice)) {
                    updateDoc(doc(db, `${publicPath}/products`, existingProd.id), { defaultUnitPrice: Number(formData.unitPrice) });
                }

            } catch (e) {
                console.error(e);
                alert("저장 실패: " + e.message);
            }
        };

        const handleDelete = async () => {
            if (!editingTask || !confirm("삭제하시겠습니까?")) return;
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, editingTask.id));
            closeTaskModal();
        };

        const handleStatus = async (id, status) => {
            const update = { status };
            if (status === 'completed') update.completionDate = serverTimestamp();
            if (status === 'paid') update.paymentDate = serverTimestamp();
            await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, id), update);
        };
        
        const openTaskModal = (task = null) => {
            setEditingTask(task);
            setFormData(task ? { 
                client: task.client, productName: task.productName, 
                quantity: task.quantity, unitPrice: task.unitPrice, 
                expense: task.expense || 0, description: task.description || '' 
            } : { 
                client: '', productName: '', quantity: 1, unitPrice: 0, expense: 0, description: '' 
            });
            setIsTaskModalOpen(true);
        };
        const closeTaskModal = () => { setIsTaskModalOpen(false); setEditingTask(null); };

        // 그룹화 로직
        const groupedTasks = useMemo(() => {
            const groups = {};
            const targetTasks = activeTab === 'progress' 
                ? tasks.filter(t => ['ready', 'processing'].includes(t.status))
                : tasks.filter(t => ['completed', 'settlement_requested'].includes(t.status));
            
            targetTasks.forEach(t => {
                const client = t.client || '미지정';
                if (!groups[client]) groups[client] = [];
                groups[client].push(t);
            });
            return groups;
        }, [tasks, activeTab]);

        if (!app) return <div className="p-10 text-center font-bold text-red-500">설정 오류</div>;
        if (!isAuthenticated) return <PinAuth onAuthenticated={() => { setIsAuthenticated(true); sessionStorage.setItem('pin_verified', 'true'); }} />;
        if (loading) return <div className="flex h-screen items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>;

        return (
            <div className="min-h-screen pb-20 max-w-lg mx-auto bg-white shadow-xl min-h-screen border-x border-gray-100 relative">
                {/* 헤더 */}
                <header className="bg-white/95 backdrop-blur-md sticky top-0 z-10 border-b border-gray-100">
                    <div className="px-4 py-2 flex justify-between items-center">
                        <h1 className="text-base font-bold text-gray-800 flex items-center gap-2">
                            작업관리 <span className="text-[10px] text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">공용</span>
                        </h1>
                        <button onClick={() => setIsProductModalOpen(true)} className="p-2 hover:bg-gray-100 rounded-full text-gray-400"><Settings size={16}/></button>
                    </div>
                    <div className="flex px-2">
                        {[ { id: 'progress', label: '진행중', icon: ClipboardList }, { id: 'completed', label: '완료/정산', icon: CheckCircle }, { id: 'stats', label: '통계', icon: TrendingUp } ].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-2 text-xs font-medium flex justify-center items-center gap-1 relative ${activeTab === tab.id ? 'text-blue-600' : 'text-gray-400'}`}>
                                <tab.icon size={14} />{tab.label}
                                {activeTab === tab.id && <div className="absolute bottom-0 w-8 h-0.5 bg-blue-600 rounded-full"></div>}
                            </button>
                        ))}
                    </div>
                </header>

                <main className="p-3 space-y-3">
                    {/* 목록 뷰 (진행중 & 완료) */}
                    {(activeTab === 'progress' || activeTab === 'completed') && (
                        <div className="animate-fade-in pb-16">
                            {Object.keys(groupedTasks).length === 0 ? 
                                <div className="py-20 text-center text-gray-300 text-xs">내역이 없습니다.</div> : 
                                Object.entries(groupedTasks).map(([client, clientTasks]) => (
                                    <div key={client} className="mb-3 bg-white border border-gray-100 rounded-lg shadow-sm overflow-hidden">
                                        {/* 거래처 헤더 */}
                                        <div className="bg-gray-50 px-3 py-1.5 border-b border-gray-100 flex justify-between items-center">
                                            <span className="font-bold text-sm text-gray-700">{client}</span>
                                            <span className="text-[10px] bg-white border px-1.5 rounded text-gray-500">{clientTasks.length}건</span>
                                        </div>
                                        {/* 작업 리스트 (한줄 보기) */}
                                        <div className="divide-y divide-gray-50">
                                            {clientTasks.map(task => (
                                                <div key={task.id} onClick={() => openTaskModal(task)} className="flex items-center p-2.5 hover:bg-blue-50 active:bg-blue-50 transition cursor-pointer">
                                                    {/* 제품명 (강조) */}
                                                    <div className="font-bold text-gray-800 text-sm truncate mr-2 flex-1 min-w-0">
                                                        {task.productName}
                                                    </div>
                                                    
                                                    {/* 수량 (배지 형태) */}
                                                    <div className="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded text-xs font-bold mr-2 whitespace-nowrap">
                                                        {task.quantity}
                                                    </div>

                                                    {/* 상태 (아이콘/텍스트) */}
                                                    <div className="mr-2" onClick={e => e.stopPropagation()}>
                                                        <select 
                                                            value={task.status} 
                                                            onChange={e => handleStatus(task.id, e.target.value)}
                                                            className={`text-[10px] border-none bg-transparent outline-none font-medium cursor-pointer ${STATUS_MAP[task.status].color.split(' ')[0]}`}
                                                        >
                                                            {Object.keys(STATUS_MAP).map(k => <option key={k} value={k}>{STATUS_MAP[k].label}</option>)}
                                                        </select>
                                                    </div>

                                                    {/* 메모 (아이콘 또는 짧은 텍스트) */}
                                                    {task.description && (
                                                        <div className="mr-2 text-gray-400" title={task.description}>
                                                            <FileText size={12} />
                                                        </div>
                                                    )}

                                                    {/* 날짜 */}
                                                    <div className="text-[10px] text-gray-400 whitespace-nowrap">
                                                        {formatDate(task.updatedAt || task.createdAt)}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    )}

                    {activeTab === 'completed' && Object.keys(groupedTasks).length > 0 && (
                        <div className="fixed bottom-20 left-0 right-0 flex justify-center pointer-events-none">
                             <button onClick={() => setIsSettlementModalOpen(true)} className="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg pointer-events-auto flex items-center gap-1">
                                <ClipboardList size={14}/> 정산 명세서 보기
                            </button>
                        </div>
                    )}

                    {activeTab === 'stats' && <StatsView tasks={tasks.filter(t=>t.status==='paid')} />}
                </main>

                {/* 플로팅 등록 버튼 (우측 하단) */}
                {activeTab === 'progress' && (
                    <button 
                        onClick={() => openTaskModal()} 
                        className="fixed bottom-6 right-6 w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg shadow-blue-200 flex items-center justify-center transition-transform active:scale-90 z-20"
                    >
                        <Plus size={24} strokeWidth={2.5} />
                    </button>
                )}

                {/* --- 입력 팝업 (상단 배치 & 최적화) --- */}
                {isTaskModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-start justify-center bg-black/40 backdrop-blur-sm animate-fade-in pt-4">
                        <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl animate-slide-up overflow-hidden mx-4">
                            {/* 헤더 */}
                            <div className="px-4 py-2.5 border-b flex justify-between items-center bg-gray-50">
                                <h3 className="font-bold text-gray-800 text-sm">{editingTask ? '작업 수정' : '새 작업 등록'}</h3>
                                <button onClick={closeTaskModal} className="w-6 h-6 flex items-center justify-center bg-gray-200 rounded-full text-gray-500 hover:bg-gray-300"><X size={14}/></button>
                            </div>
                            
                            <div className="p-4 space-y-3">
                                {/* 거래처 / 제품명 */}
                                <div className="grid grid-cols-2 gap-2">
                                    <CompactAutocomplete label="거래처" placeholder="입력" value={formData.client} onChange={v => setFormData({...formData, client: v})} options={clients} />
                                    <CompactAutocomplete label="제품명" placeholder="입력" value={formData.productName} onChange={v => setFormData({...formData, productName: v})} options={products} onSelect={p => setFormData(prev => ({...prev, unitPrice: p.defaultUnitPrice || 0}))} />
                                </div>

                                {/* 수량 / 단가 */}
                                <div className="grid grid-cols-3 gap-2">
                                    <div className="col-span-1">
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">수량</label>
                                        <input 
                                            type="number" 
                                            className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-sm text-center font-bold focus:ring-1 focus:ring-blue-500 outline-none" 
                                            value={formData.quantity} 
                                            onChange={e => setFormData({...formData, quantity: e.target.value})}
                                            onFocus={(e) => e.target.select()} 
                                        />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-xs font-semibold text-gray-500 mb-1">단가</label>
                                        <input 
                                            type="number" 
                                            className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-sm text-right font-bold focus:ring-1 focus:ring-blue-500 outline-none" 
                                            value={formData.unitPrice} 
                                            onChange={e => setFormData({...formData, unitPrice: e.target.value})}
                                            onFocus={(e) => e.target.select()} 
                                        />
                                    </div>
                                </div>

                                {/* 버튼 영역 (비고 위로 이동) */}
                                <div className="grid grid-cols-2 gap-2 pt-1">
                                    {/* 수정 모드일 때 삭제 버튼 표시 */}
                                    {editingTask ? (
                                        <button onClick={handleDelete} className="bg-red-50 text-red-500 py-2.5 rounded font-bold text-xs border border-red-100">삭제</button>
                                    ) : (
                                        <button onClick={() => handleSaveTask(true)} className="bg-blue-50 text-blue-600 py-2.5 rounded font-bold text-xs border border-blue-100 flex items-center justify-center gap-1">
                                            <Plus size={14}/> 저장 후 추가
                                        </button>
                                    )}
                                    <button onClick={() => handleSaveTask(false)} className="bg-blue-600 text-white py-2.5 rounded font-bold text-xs shadow hover:bg-blue-700">
                                        {editingTask ? '수정 완료' : '등록 완료'}
                                    </button>
                                </div>

                                {/* 비고 (맨 아래) */}
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1">비고 (선택)</label>
                                    <textarea className="w-full px-2 py-2 bg-gray-50 border border-gray-200 rounded text-sm h-12 resize-none focus:ring-1 focus:ring-blue-500 outline-none" placeholder="특이사항 메모" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {isSettlementModalOpen && <SettlementPreviewModal tasks={completedTasks.filter(t=>t.status==='completed')} onClose={()=>setIsSettlementModalOpen(false)} onConfirm={async ()=>{ const batch=writeBatch(db); completedTasks.filter(t=>t.status==='completed').forEach(t=>batch.update(doc(db,`artifacts/${appId}/public/data/tasks`,t.id),{status:'settlement_requested', settlementDate:serverTimestamp()})); await batch.commit(); setIsSettlementModalOpen(false); }} />}
                {isProductModalOpen && <ProductManagerModal onClose={()=>setIsProductModalOpen(false)} products={products} db={db} appId={appId} />}
            </div>
        );
    };

    // --- 서브: 제품관리 모달 ---
    const ProductManagerModal = ({ onClose, products, db, appId }) => {
        const [name, setName] = useState(''); const [price, setPrice] = useState('');
        const add = async () => { if(name) { await addDoc(collection(db, `artifacts/${appId}/public/data/products`), {name, defaultUnitPrice:Number(price)}); setName(''); } };
        return <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-6 backdrop-blur-sm"><div className="bg-white w-full max-w-sm rounded-2xl shadow-xl overflow-hidden"><div className="p-3 border-b flex justify-between font-bold items-center bg-gray-50"><span>제품 관리</span><button onClick={onClose}><X size={18}/></button></div><div className="p-3 bg-gray-50 border-b flex gap-2"><input className="flex-1 p-2 border rounded-lg text-sm" placeholder="제품명" value={name} onChange={e=>setName(e.target.value)}/><input type="number" className="w-20 p-2 border rounded-lg text-sm" placeholder="단가" value={price} onChange={e=>setPrice(e.target.value)}/><button onClick={add} className="bg-green-500 text-white px-3 rounded-lg text-sm font-bold">추가</button></div><div className="max-h-60 overflow-y-auto p-2">{products.map(p=><div key={p.id} className="flex justify-between p-2 border-b last:border-0 text-sm items-center"><span>{p.name} <span className="text-gray-400 text-xs">({formatCurrency(p.defaultUnitPrice)})</span></span><button onClick={()=>deleteDoc(doc(db,`artifacts/${appId}/public/data/products`,p.id))} className="text-red-400"><Trash2 size={14}/></button></div>)}</div></div></div>;
    };

    // --- 서브: 정산 미리보기 ---
    const SettlementPreviewModal = ({ tasks, onClose, onConfirm }) => {
        const txt = useMemo(() => { let t = `[정산요청] ${new Date().toLocaleDateString()}\n`; const g = {}; tasks.forEach(i => { const c = i.client||'기타'; if(!g[c]) g[c]=[]; g[c].push(i); }); let tot=0; Object.entries(g).forEach(([c,l]) => { t += `\n■ ${c}\n`; l.forEach(i => { t += `- ${i.productName} (${i.quantity}개): ${formatCurrency(i.revenue)}\n`; tot+=i.revenue; }); }); t += `\n총액: ${formatCurrency(tot)}`; return t; }, [tasks]);
        const copy = () => { navigator.clipboard.writeText(txt).then(()=>alert("복사됨")); };
        return <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-6"><div className="bg-white w-full max-w-sm rounded-2xl shadow-xl flex flex-col max-h-[80vh]"><div className="p-3 border-b flex justify-between font-bold"><span>미리보기</span><button onClick={onClose}><X size={18}/></button></div><pre className="p-4 bg-gray-50 flex-1 overflow-auto text-xs whitespace-pre-wrap leading-relaxed">{txt}</pre><div className="p-3 border-t flex gap-2"><button onClick={copy} className="flex-1 bg-gray-800 text-white py-2 rounded-lg text-sm font-bold">복사</button><button onClick={onConfirm} className="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-bold">요청 확정</button></div></div></div>;
    };

    // --- 서브: 통계 ---
    const StatsView = ({ tasks }) => {
        const [m, setM] = useState(new Date().toISOString().slice(0,7));
        const f = tasks.filter(t => t.paymentDate && formatDate(t.paymentDate).startsWith(parseInt(m.slice(5)))); // 단순 월 필터링
        const tot = f.reduce((a,b)=>a+b.revenue,0);
        return <div className="animate-fade-in"><div className="bg-white border rounded-xl p-4 mb-4"><div className="flex justify-between items-center mb-2"><span className="text-sm font-bold text-gray-500">이번 달 순수익</span><input type="month" value={m} onChange={e=>setM(e.target.value)} className="text-xs border rounded p-1"/></div><div className="text-2xl font-bold text-blue-600">{formatCurrency(tot)}</div></div><div className="bg-white border rounded-xl overflow-hidden"><div className="bg-gray-50 px-4 py-2 text-xs font-bold text-gray-500">지급 완료 목록</div>{f.map(t=><div key={t.id} className="p-3 border-b last:border-0 flex justify-between text-sm"><span>{t.productName}</span><span className="font-bold text-green-600">+{formatCurrency(t.revenue)}</span></div>)}</div></div>;
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
